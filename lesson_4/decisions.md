# Принятые решения

Раз уж я делал нулевую домашку, то я решил вынести сервисы из нее, а не из предложенного решения.

## Маппинг нулевой домашки на контексты и домены

В нулевой домашке нет ни контекстов, ни доменов, так что сначала надо их сделать исходя из того, 
что там есть.
Лучше всего для этого подойдет [Services Diagram]. Там уже техническое решение, но можно выделить
контексты и домены.
Получилось [следующая схема контекстов и доменов в Miro] и [схема сервисов там же]. 
Тут есть следующие проблемы:
1. Я предполагал, что все - это core функицонал
2. Неправильное разбиение контекстов по доменам (и часть доменов отсутствует 
   (например, лояльность клиентов))
3. Единый биллинг для клиентов и воркеров
4. Нет отдельного домена матчинга (хотя тогда и требования для матчинга были другими)
5. Порталы были FE приложениями, слой API - слишком техничский шаг, чтобы его отображать.

В итоге я хочу получить то же самое, что получилось в третьем уроке со следующими отличиями:
1. Сервис биллинга - тут вместо одного microkernel сервиса будет два service-based (для клиентов и
   воркеров) с общей базой.
2. Контроль качества будет частью сервиса организации выездов.
3. Адаптер для интеграции с доставкой печенья будет частью сервиса комплектации заказов


## Определение недостающих связей и вычисление Instability

Для начала надо вычислить Instability. Для этого надо перерисовать сервисы со связями.
Получилась такая [карта сервисов].
Система сильно отличается от предложенной альтернативы для домашки из четвертого урока.
Тут есть несколько проблем:
* Не были выявлены архитектурные характеристики системы. Из-за этого пропал отдельный контекст
  для расчета воркеров, сервис для матчинга и внешние системы.
* Не были определены важные поддомены (и вообще поддомены) бизнеса из-за чего все поддомены - это кор
поддомены, и из-за этого `modifiability` и `maintainability` будут во всех доменах
* Асинхронные коммуникации внутри сервиса задач между модулями, что, вообще говоря, можно сделать (и
  даже иногда нужно - у меня был опыт), но точно не в данном случае. Мы сильно усложним этим разработку.

### Считаем Instability

Формула для Instability:
I = Ce / (Ca + Ce).

* Для сервиса оценки котов-кандидатов получается I =   1 / (0 + 1) = 1
* Для сервиса задач - I = 1 / (1 + 1) = 0.5
* для сервиса биллинга - I = 0 / (1 + 0) = 0

То есть на сервис оценки котов-кандидатов изменения в системе влияют больше всего, а на сервис биллинга не влияют.

Из этого получаются следующие проблемы:
1. На самом деле биллинг - это не core поддомен, а контекст generic поддомена, то есть его инстабилити
нас интересует меньше, чем инстабилити других сервисов.
2. Единственный настоящий core поддомен - оценка котов-кандидатов - получился самым нестабильным.
3. В данном случае выходит, что Instability нам интересен меньше, чем другие проблемы данного решения.

### Проблемы решения нулевой домашки

Помимо Instability из-за неправильного анализа системы получились следующие проблемы:
1. Все поддомены - core поддомены, из-за чего ресурсы бизнеса будут потрачены неправильным образом и
важные для бизнеса фичи (например, рекрутинг котов) могут получиться хуже по качеству или
не получиться совсем.
2. Тут матчинг - это часть контекста выполнения заказов (мем с Дио здесь), а на самом деле это отдельный кор поддомен
со своей реализацией и с другими архитектурными характеристиками. В какой-то момент поддерживать это
станет невозможно и придется это долго и мучительно выносить.
3. Я не заметил различий между расчетами для клиетов и для воркеров, из-за чего получился один домен и
сервис для них несмотря на разные характеристики для этих элементов
(modifiability, evolability и configurability для расчета клиентов) исходя из требований 
(разные интеграции для клиентов, разные биллинг циклы)
4. Модуль тотализатора включен в сервис задач, у которого есть характеристика scalability. Это
приведет к тому, что мы будем скейлить все включая тотализатор, хотя могли бы вынести его в отдельный
сервис (особенно при условии того, что ожидаются редкие изменения в логике этого модуля).
5. Модуль расходников можно вынести, а можно оставить. Так как нельзя спросить бизнес о том, в какое
время должен быть сформирован заказ, то я оставлю его вместе с модулем задач, чтобы скейлить параллельно
с ним. В будущем можно будет вынести его в отдельный сервис и работать с ним асинхронно.

## Infamous ~~Billing~~ Service Extraction

### Как сервисы и боундед-контексты будут меняться

1. Объединяем домен биллинга и задач и передлываем его в Generic
   * Контекст расчетов разделяем на два - для клиентов и для воркеров
   * При этом сервисы биллинга должны быть отдельным сервисами - для клиентов и для воркеров
2. Выделяем тотализатор в отдельный контекст мотивации менеджеров и туда же выделяем этот контекст
3. Из контекста Модуля заказов выделяем домен и контекст матчинга
4. Выделяем домен лояльности клиентов (печеньки)

### Есть ресурсы и люди, но нет экспертизы/инфраструктуры

1. Если есть возможность, я бы начал с имплементации новой фичи как отдельного сервиса.
   * Если такой возможности нет, то я берем тотализатор и выносим его в отдельный сервис. Это простой и неважный 
     для бизнеса домен
   * Тут подойдет Tactical Forking. Но из-за того, что здесь мы хотим потренироваться и набрать экспертизы
     я бы использовал Change Data Capture, так как мы будем использовать этот метод для вынесения сложных сервисов
2. Далее разделяем сервис Биллинга на два сервиса с одной базой, чтобы получить service-based с двумя сервисами.
   * Биллинг не является Core поддоменом, поэтому выбираем его, а уже потом Core поддомены
   * Тут нет смысла в Change Data Capture, так как база остается одной. Используем Tactical Forking, конфигурируем
     функционал в обоих биллингах 
3. Далее выносим Матчинг из Сервиса Задач.
   * Это Core поддомен, с другой БД, другой архитетурой и, возможно, написанный на другом языке.
   * Здесь нам нужен Change Data Capture. Сначала перенесем данные, затем код.
     * Для первоначальной миграции импортируем данные "руками". Все последующее данные будет стримить асинхронно.
   * После перенесения кода проводим тестирование и уже после этого переключаем трафик на новый сервис.

Стоит сказать, что для всех таких вынесений сервисов надо использовать Release Feature Flag'и для включения нового
сервиса в основной флоу (переключений трафика на него).

### Нет ни людей. ни ресурсов, ~~ни экспертизы, ни инфраструктуры~~ но есть экспертиза и инфраструктура

Тут у нас мало времени, так что начинаем с самого важного для бизнеса, вынесение чего нам принесет наибольший эффект.

1. Тут мы сразу начинаем с вынесения алгоритма матчинга из Сервиса Задач.
   * Применяем Change Data Capture. Сначала данные, потом код. Также сначала большой импорт данных, затем асинхронный 
     стриминг
     * На самом деле в реальности это выглядит немного сложнее, но я решил не углубляться в технические детали
   * Также итеративно переносим код и переключаем трафиик на новый сервис.
2. Затем разделяем биллинг с использованием Tactical Forking.
   * Создаем сервис, переносим туда логику работы с воркерами, переключаем трафик.
3. И уже потом переносим Тотализатор
   * Так как у нас есть эксперты в экстракции сервисов, то тренироваться тут смысла нет - 
     сразу используем Tactical Forking.
   * После перенесения кода и данных переключаем трафик (он тут только внутренний) на Тотализатор.

В итоге получается [следующая система].
В финальном варианте мне все нравится, но я вижу спорных момента:
* У меня коты-кандидаты и коты-воркеры совсем разные сущности, и кот-воркер создается бизнес эвентом из 
сервиса рекрутинга. Не уверен, что должно быть так (возможно тут стриминг, например)
* Я хотел сделать асинхронное взаимодействие Между планированием визитов и Сервисом матчинга, но кажется, что
клиенты будут ждать ответа в реальном времени, то есть нам придется делать синхронное взаимодействие тут.
  * Из-за этого на матчинг перейдет характеристика Scalability (даже без учета потенциальной нагрузки от других бизнесов)
    и надо будет это учитывать (circuit breaker'ы, например).

### Entity сервис

В отличие от альтернативной домашки у меня нет Entity сервиса, так что опишу как я бы от него избавлялся.
Для этого сервиса Instability = Ce / (Ca + Ce) = 4 / 5 = 0.8, то есть этот сервис с большой вероятностью надо
будет менять из-за изменений в других компонентах системы.

Варианта тут два:

1. Сделать его частью сервиса скоринга кандидатов
2. Сделать его частью Сервиса планирования визитов (матчинг оттуда надо будет убрать)

При этом количество связей сильно уменьшится только в случае его мержа с Сервисом планирования визитов, так что
лучше убрать его туда.

#### Люди, ресурсы без инфры и экспертизы

На самом деле это саппортинг домен, но из-за сложности мержа мы дойдем до него уже после экстракции/мержа других сервисов.
Таким образом:
1. Используем Change Data Capture. Переносим все данные большой миграцией, далее - стримим изменения.
2. Переносим код в сервис задач
3. Проводим тестирование (тут может подойти контрактное тестирование)
4. Переключаем трафик 
5. Если все хорошо, то удаляем старый сервис

#### Инфра и экспертиза без людей и ресусров

Домен не такой важный, как остальные Core поддомены, но после него будет проще экстрактить другие сервисы.
Так что это будет первый кандидат на рефакторинг после Core поддоменов.
Порядок рефакторинга такой же, как и в предыдущем случае.
1. Используем Change Data Capture. Переносим все данные большой миграцией, далее - стримим изменения.
2. Переносим код в сервис задач
3. Проводим тестирование (тут может подойти контрактное тестирование)
4. Переключаем трафик
5. Если все хорошо, то удаляем старый сервис

--- 

[Services Diagram]: https://lucid.app/lucidchart/bedf4e29-bcc3-4db8-9044-5c40042b560e/edit?viewport_loc=-456%2C103%2C1963%2C1033%2C0_0&invitationId=inv_3dd92bfe-4c1b-4cce-b895-d13ce82916f8
[следующая схема контекстов и доменов в Miro]: https://miro.com/app/board/uXjVLrCcUFQ=/?moveToWidget=3458764616434707984&cot=14
[схема сервисов там же]: https://miro.com/app/board/uXjVLrCcUFQ=/?moveToWidget=3458764616434708224&cot=14
[карта сервисов]: https://miro.com/app/board/uXjVLrCcUFQ=/?moveToWidget=3458764616435621228&cot=14
[следующая система]: https://miro.com/app/board/uXjVLrCcUFQ=/?moveToWidget=3458764616441198907&cot=14
